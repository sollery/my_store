
{% extends '_base.html' %}
{% load static %}
{%block title %}
{% endblock title %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class = "image-zoom" >
                    <img id = goods-max src="{{ product.productimage_set.all.0.image.url }}" class="img-responsive" height="450" width="400">
                    <div class="image-zoom-block"></div>
                </div>
                <div class = "goods-img-min">
                {% for image_item in product.productimage_set.all %}
                    <div class = img_min>
                        <img src="{{ image_item.image.url }}" class="img-responsive goods-min" height="100" width="150">
                    </div>
                {% endfor %}
                </div>
                 <div class="rating_p" data-total-value="{{avg_stat | floatformat:0}}">
                            <div class="rating_item_p" data-item-value="5">★</div>
                            <div class="rating_item_p" data-item-value="4">★</div>
                            <div class="rating_item_p" data-item-value="3">★</div>
                            <div class="rating_item_p" data-item-value="2">★</div>
                            <div class="rating_item_p" data-item-value="1">★</div>
                     <h3 class="rating_stat">Рейтинг: {{avg_stat}}</h3>
                        </div>

                <input class = "hide_rew" id="click-to-hide-2" type="button" value="Показать отзывы">
            </div>
            <div class="col-lg-6 text-center">
                <h1>
                    {{ product.name }}
                </h1>
                <div>
                    <p>
                        <h4>Цена: <span id = "product_price{{product.id}}">{{ product.price }}</span> руб.</h4>
                    </p>
                </div>
                        <div role="tabpanel" class="tab-pane active" id="description">
                            <span class="text-center" >{{ product.description }}</span>
                        </div>
                <div>
                        {% csrf_token %}
                    <div class ="info_item_btn">
                        {% if product.get_id in cart.cart %}
                            <a href="{% url 'cart_detail' %}" class="btn btn-info">в корзине</a>
                        {% else %}
                            <button data-change="add" id="add_basket{{ product.id }}" class="change btn btn-success btn-buy add"
                                data-product_id = "{{ product.id }}"
                                data-name ="{{ product.name }}"
                                data-price ="{{ product.price }}">Купить
                            </button>
                            <a href="{% url 'cart_detail' %}" id="in_basket{{ product.id }}" class="btn btn-info" hidden>в корзине</a>
                         {%endif%}
                    </div>
                </div>


            </div>
         </div>
        <div class="row ">
            <div class="col-lg-6 comment hide-element wpcraft-box-2 ">
                <div class = "lst_rew news-list">
            {% for review in product.get_review %}
                {% include 'review-item.html' %}
            {% endfor %}
            </div>

<!--                <div id="pagination">-->
<!--                    <span class="step-links">-->
<!--                        {% if page_obj.has_previous %}-->
<!--                            <a class = "page-link" href="?page=1">Начало</a>-->
<!--                            <a class = "page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a>-->
<!--                        {% endif %}-->
<!--                        <span class="current">-->
<!--                            стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.-->
<!--                        </span>-->

<!--                        {% if page_obj.has_next %}-->
<!--                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a>-->
<!--                            <a class = "page-link" href="?page={{ page_obj.paginator.num_pages }}">Конец</a>-->
<!--                        {% endif %}-->
<!--                    </span>-->
<!--                </div>-->
            </div>

            <div class="col-lg-6 frm_rew">
                {% if user.is_authenticated %}
                    {% if rating_p %}
                        <h2>Изменить оценку</h2>
                            <div class="rating" data-total-value="{{rating_p}}" data-product_id="{{product.id}}">
                                <div class="rating_item" data-item-value="5">★</div>
                                <div class="rating_item" data-item-value="4">★</div>
                                <div class="rating_item" data-item-value="3">★</div>
                                <div class="rating_item" data-item-value="2">★</div>
                                <div class="rating_item" data-item-value="1">★</div>
                            </div>
                    {% else %}
                        <h2>Оцените товар</h2>
                            <div class="rating" data-total-value="{{rating_p}}" data-product_id="{{product.id}}">
                                <div class="rating_item" data-item-value="5">★</div>
                                <div class="rating_item" data-item-value="4">★</div>
                                <div class="rating_item" data-item-value="3">★</div>
                                <div class="rating_item" data-item-value="2">★</div>
                                <div class="rating_item" data-item-value="1">★</div>
                            </div>
                    {%endif%}
                    <h1 class="rating_y"></h1>
                        <h2>Оставить отзыв</h2>
                        <form id = "formReview" action="." method="post">
                            <input type="hidden" name="parent" id="contactparent" value="">
                            <input type="hidden" name="product_id"  value="{{ product.id }}">
                            {{ review_form.as_p }}
                            {% csrf_token %}
                            <p><input type="button" data-change="add" value="Добавить отзыв" class="change_rew add add_rew" id="add_rew" data-product_id ="{{ product.id }}" data-review_id = "{{ review.id }}"></p>
                        </form>
                {%else%}
                    <div>
                        <h3>чтобы оставить отзыв или оценить товар нужно <a href="{% url 'account_login' %}">Войти</a> или <a href="{% url 'account_signup' %}">Зарегистрироваться</a></h3>
                     </div>
                {%endif%}
            </div>
        <!--<h1>Отзывы</h1>
        <div class="row">
            <div class="col-lg-4">
            {%for i in reviews %}
                <span>Автор:{{i.author}}</span>
                <p>сообщение: {{i.review}}</p>
            {%endfor%}
            </div>
        </div>-->
        </div>
        <div id="goTop" style="position: fixed; right: 50px; bottom: 50px;  color: black; width: 50px; height:100px; display: none;">&#8679;</div>
    </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

<!--        $(document).ready(function () {-->
<!--            window.news_index = "{% url 'product_detail' product.pk product.slug %}";-->

<!--            var page = 1;-->
<!--            var block_request = false;-->
<!--            var end_pagination = false;-->

<!--            $(window).scroll(function () {-->
<!--                var margin = $(document).height() - $(window).height() - 200;-->

<!--                if ($(window).scrollTop() > margin && end_pagination === false && block_request === false) {-->
<!--                    block_request = true;-->
<!--                    page += 1;-->

<!--                    $.ajax({-->
<!--                        type: 'GET',-->
<!--                        url: window.news_index,-->
<!--                        data: {-->
<!--                            "page": page-->
<!--                        },-->
<!--                        success: function (data) {-->
<!--                            if (data.end_pagination === true) {-->
<!--                                end_pagination = true;-->
<!--                            } else {-->
<!--                                block_request = false;-->
<!--                            }-->
<!--                            $('.news-list').append(data.content);-->
<!--                        }-->
<!--                    })-->
<!--                }-->
<!--            });-->
<!--        })-->
         const goTopBtn = document.getElementById('goTop')
             // Изначально высота верхнего содержимого, загружаемого браузером, равна 0
          let scrollTop = 0
             // слушаем события прокрутки страницы
          window.onscroll = () => {
                 // Получаем высоту верхнего содержимого, которое отображается в браузере
            scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                 // Если высота свернутого содержимого больше 50, отобразить кнопку для возврата наверх;
                 // Если высота сворачиваемого содержимого меньше 50, скройте кнопку, чтобы вернуться наверх.
            scrollTop > 50 ? (goTopBtn.style.display = 'block') : (goTopBtn.style.display = 'none')
          }
          goTopBtn.onclick = () => {
                 // Очищаем последний таймер
            let timer = null;
            clearInterval(timer);
                 // Создаем таймер и выполняем стрелочную функцию каждые 15 мсек.
            timer = setInterval(()=>{
                     // Каждый раз, когда функция выполняется, scrollTop уменьшается на одну десятую
              scrollTop -= scrollTop / 10;
              window.scrollTo(0,scrollTop)
                     // Когда scrollTop меньше 2, напрямую устанавливаем scrollTop на 0 и очищаем таймер.
              if(scrollTop<2){
                window.scrollTo(0,0);
                clearInterval(timer);
              }
            },15)
          }

        var clickToHide2 = document.querySelector('#click-to-hide-2');
        clickToHide2.addEventListener("click", hideVisibleElem);

        //	/* Функция добавления / удаления класса, который скрывает элемент */
        function hideVisibleElem() {
        let wpcraftBox2 = document.querySelector('.wpcraft-box-2');
        wpcraftBox2.classList.toggle("hide-element");
        //
        //	/* В зависимости от наличия скрывающего класса меняем текст в кнопке */
        if (wpcraftBox2.classList.contains("hide-element")){
            clickToHide2.value = 'Показать отзывы';
        } else {
            clickToHide2.value = 'Скрыть отзывы';
        }
        }
        $(document).ready(function(){
            $('.fotki a').mouseover(function(){
                e.preventDefault();
                $('.image-zoom img').attr("src",$(this).attr("href"))
            })
            console.log('1111111111111')
        })
        document.body.onclick= function(event) {
            event = event || window.event;
            if (event.target.classList.contains('goods-min')) {
                document.getElementById('goods-max').src = event.target.src;
            }
        }
         function addReview(name, id) {
            document.getElementById("contactparent").value = id;
            document.getElementById("id_text").innerText = `${name}, `
        }
        var add_rew = document.querySelector('.add_rew');
        add_rew.onclick = function () {
            const postForm = document.querySelector("#formReview");
            formData = new FormData(postForm);
            fetch('http://127.0.0.1:8000/shop/data_review/', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    postForm.reset();
                    console.log(data)
                })
        //        .catch((error) => {
        //            console.error('Error:', error);
        //        });
            }
    </script>
{% endblock %}